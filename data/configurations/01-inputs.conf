# 01-inputs.conf
input {
  udp {
    port => 5140
  }
}
filter {
#########################################################
# Adjust to match the IP address of pfSense or OPNsense #
#########################################################
  if [host] =~ /172\.22\.33\.1/ {
    mutate {
      add_tag => [ "pf", "Ready" ]
      add_field => [ "[observer][type]", "firewall" ]
    }
  }
#########################################################################################
#To enable or ingest multiple pfSense or OPNsense instances uncomment the below section #
#########################################################################################
#if [host] =~ /172\.2\.22\.1/ {
#  mutate {
#    add_tag => ["pf", "Ready"]
#    add_field => [ "[observer][type]", "firewall" ]
#  }
#}
#########################################################################################
  if "pf" in [tags] {
    grok {
      # OPNsense - Enable/Disable the line below based on firewall platform
      match => { "message" => "<(?<[event][id]>.*)>%{SYSLOGTIMESTAMP:[event][created]} %{SYSLOGHOST:[observer][name]} %{DATA:labels}(?:\[%{POSINT:pf_pid}\])?: %{GREEDYDATA:pf_message}" }
      ########################################################################################################################################
      # pfSense - Enable/Disable the line below based on firewall platform
      # match => { "message" => "<(?<[event][id]>.*)>%{SYSLOGTIMESTAMP:[event][created]} %{DATA:labels}(?:\[%{POSINT:[event][id]}\])?: %{GREEDYDATA:pf_message}" }
    }
    mutate {
      rename => { "[message]" => "[event][original]"}
      remove_tag => "Ready"
    }

    # pfSense < v2.5 uses syslog format RFC 3164. pfSense > 2.5 uses either syslog format RFC 3164 or RFC 5424
    # pfSense syslog RFC 3164 does not have a year. This is an imperfect hack to add a year to the event using the current year.
    # Example input: May  3 18:16:05
    # Example output: 2020-05-03T18:16:05.000Z
    grok {
      match => { "[event][created]" => "%{MONTH:[@metadata][syslogtimestampmonth]}\s*%{MONTHDAY:[@metadata][syslogtimestampday]}\s%{TIME:[@metadata][syslogtimestamptime]}"}
    }
    mutate {
      add_field => {"[@metadata][currentyear]" => "%{+YYYY}"} 
      add_field => {"[@metadata][syslogtimestamphack]" => "%{[@metadata][currentyear]} %{[@metadata][syslogtimestampmonth]} %{[@metadata][syslogtimestampday]} %{[@metadata][syslogtimestamptime]}"}
    }
    date {
        match => ["[@metadata][syslogtimestamphack]", "yyyy MMM dd HH:mm:ss", "yyyy MMM d HH:mm:ss"]
        target => "[event][created]"
    }
  }
}
